# 磁盘管理

磁盘管理非常重要：涉及存储。

对于磁盘的操作要谨慎！！！



1.硬盘分类

`HDD`

`SSD`



扇区是硬盘中最小存储单元，默认是512字节(byte)，1字节=8位(bit)

关于存储大小：T<E<Z<Y



机械硬盘慢就是因为有寻道时间。

顺序读写（连续读写）快，磁头一把转过来。

随机读写慢。

性能调优：不要着急处理请求（滞后-磁头稍后调），合并扇区后一块查询出来相近的数据。



块设备 block

字符串设备

队列



2.`Linux`对硬盘接口的命名

`USB`、`SATA`、`SCSI`:` /dev/sd`

`IDE`:`/dev/hd`

`KVM`: `/dev/vd`

`NVME`:`/dev/nvmeXX`



3.分区方案

`MBR`（master boot record - 主引导记录) 格式：

446 `bootloader`+64分区记录表+2结束位

每个`MBR`格式的硬盘，最大支持4个主分区

每个P分区占用16个字节的分区记录表

```
                                    |----------扩展分区---------|
MBR分区表 | 主分区C | 主分区D | 主分区E |逻辑分区F|逻辑分区G|逻辑分区H|
```



`GPT`格式：

它最大支持128个分区。



关于常见的文件系统格式：

U盘默认`FAT32`, 拷贝不能超过`4T`以上的原因就在于 不同的**文件系统管理数据**的方式不同，因此需要格式化为`NTFS`格式

Windows下默认`NTFS`格式



关于Linux下的文件系统格式：

`XFS` 处理大数据，不易处理碎片文件

`EXT4` 适合普通场景

需要根据适用场景选择

详情参考红帽官方文档 https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/10#Storage

专业称谓：根文件系统而不是根分区、`dev`文件系统而不是`dev`分区



4.命令行管理磁盘存储

步骤

- a.分区

  `fdisk  -l `查看所有块设备和分区情况

- b.格式化

  格式化：创建文件系统的过程。

  没有格式化的，叫做裸设备

  一旦格式化的，就是块设备

  块设备其实是站在文件系统角度来考虑的。

  一个块对应8个扇区（4k）

  名词：`sectors`——扇区

  `mkfs.格式  设备名称`

- c.挂载

  <u>为什么要挂载？</u>

  <u>挂载的意义在于将设备加入到这个文件系统树当中</u>

  > 临时挂载
  >
  > mkdir  /挂载点
  >
  > mount  /dev/设备   /挂载点
  >
  > df  -h  查看正在备挂载中的文件系统信息

  `df` 命令只能看正在挂载的信息

  > 持久挂载
  >
  > 
  >
  > 修改文件启动表
  >
  > ```shell
  > [root@bogon ~]# vim /etc/fstab
  > ```
  >
  > ```shell
  > # 设备名   挂载点  文件系统格式  defaults        0 0
  > # 后面的 defaults 0 0 这三项都一样，可以照抄
  > 
  > /dev/sdb1             /hahaha     ext4             defaults        0 0
  > 
  > UUID=8cabbd4c-3b96-4efc-8733-426417f25623             /hahahaha     ext4             defaults        0 0
  > 
  > ##### [root@bogon ~]# blkid 
  > ##### 使用blkid命令获取查看uuid
  > ##### 当我们对一个设备格式化以后就会分配一个uuid
  > ##### [root@bogon ~]# lsblk -fs
  > ##### 使用lsblk -fs命令也可以获取设备的uuid
  > ```
  >
  > ```shell
  > ##### mount -a刷新
  > 
  > [root@bogon ~]# mount -a
  > [root@bogon ~]# cat /proc/partitions 
  > ```



完整示例

```shell
Xshell 5 (Build 0964)
Copyright (c) 2002-2016 NetSarang Computer, Inc. All rights reserved.

Type `help' to learn how to use Xshell prompt.
[d:\~]$ 

Connecting to 192.168.72.130:22...
Connection established.
To escape to local shell, press 'Ctrl+Alt+]'.

Last login: Thu Oct 30 11:22:23 2025
[root@bogon ~]# cat /proc/partitions
major minor  #blocks  name

   8        0   20971520 sda
   8        1    1048576 sda1
   8        2   19921920 sda2
   8       16    5242880 sdb
  11        0    4415488 sr0
 253        0   17821696 dm-0
 253        1    2097152 dm-1
[root@bogon ~]# fdisk -l

磁盘 /dev/sda：21.5 GB, 21474836480 字节，41943040 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
磁盘标签类型：dos
磁盘标识符：0x000e720d

   设备 Boot      Start         End      Blocks   Id  System
/dev/sda1   *        2048     2099199     1048576   83  Linux
/dev/sda2         2099200    41943039    19921920   8e  Linux LVM

磁盘 /dev/sdb：5368 MB, 5368709120 字节，10485760 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节


磁盘 /dev/mapper/centos-root：18.2 GB, 18249416704 字节，35643392 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节


磁盘 /dev/mapper/centos-swap：2147 MB, 2147483648 字节，4194304 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节

[root@bogon ~]# fdisk /dev/sdb
欢迎使用 fdisk (util-linux 2.23.2)。

更改将停留在内存中，直到您决定将更改写入磁盘。
使用写入命令前请三思。

Device does not contain a recognized partition table
使用磁盘标识符 0x8ea19066 创建新的 DOS 磁盘标签。

命令(输入 m 获取帮助)：m
命令操作
   a   toggle a bootable flag
   b   edit bsd disklabel
   c   toggle the dos compatibility flag
   d   delete a partition
   g   create a new empty GPT partition table
   G   create an IRIX (SGI) partition table
   l   list known partition types
   m   print this menu
   n   add a new partition
   o   create a new empty DOS partition table
   p   print the partition table
   q   quit without saving changes
   s   create a new empty Sun disklabel
   t   change a partition's system id
   u   change display/entry units
   v   verify the partition table
   w   write table to disk and exit
   x   extra functionality (experts only)

命令(输入 m 获取帮助)：n
Partition type:
   p   primary (0 primary, 0 extended, 4 free)
   e   extended
Select (default p): p
分区号 (1-4，默认 1)：1
起始 扇区 (2048-10485759，默认为 2048)：
将使用默认值 2048
Last 扇区, +扇区 or +size{K,M,G} (2048-10485759，默认为 10485759)：+1G
分区 1 已设置为 Linux 类型，大小设为 1 GiB

命令(输入 m 获取帮助)：p

磁盘 /dev/sdb：5368 MB, 5368709120 字节，10485760 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
磁盘标签类型：dos
磁盘标识符：0x8ea19066

   设备 Boot      Start         End      Blocks   Id  System
/dev/sdb1            2048     2099199     1048576   83  Linux

命令(输入 m 获取帮助)：w
The partition table has been altered!

Calling ioctl() to re-read partition table.
正在同步磁盘。
[root@bogon ~]# mkfs.
mkfs.btrfs   mkfs.ext2    mkfs.ext4    mkfs.minix   mkfs.vfat    
mkfs.cramfs  mkfs.ext3    mkfs.fat     mkfs.msdos   mkfs.xfs     
[root@bogon ~]# mkfs.ext4 /dev/sdb1
mke2fs 1.42.9 (28-Dec-2013)
文件系统标签=
OS type: Linux
块大小=4096 (log=2)
分块大小=4096 (log=2)
Stride=0 blocks, Stripe width=0 blocks
65536 inodes, 262144 blocks
13107 blocks (5.00%) reserved for the super user
第一个数据块=0
Maximum filesystem blocks=268435456
8 block groups
32768 blocks per group, 32768 fragments per group
8192 inodes per group
Superblock backups stored on blocks: 
	32768, 98304, 163840, 229376

Allocating group tables: 完成                            
正在写入inode表: 完成                            
Creating journal (8192 blocks): 完成
Writing superblocks and filesystem accounting information: 完成

[root@bogon ~]# mkdir /hahaha
[root@bogon ~]# mount /dev/sdb1 /hahaha
[root@bogon ~]# df   -h 
文件系统                 容量  已用  可用 已用% 挂载点
/dev/mapper/centos-root   17G   15G  2.6G   85% /
devtmpfs                 897M     0  897M    0% /dev
tmpfs                    912M     0  912M    0% /dev/shm
tmpfs                    912M  9.0M  903M    1% /run
tmpfs                    912M     0  912M    0% /sys/fs/cgroup
/dev/sda1               1014M  179M  836M   18% /boot
tmpfs                    183M   24K  183M    1% /run/user/0
/dev/sr0                 4.3G  4.3G     0  100% /run/media/root/CentOS 7 x86_64
/dev/sdb1                976M  2.6M  907M    1% /hahaha
[root@bogon ~]# cd /haha
-bash: cd: /haha: 没有那个文件或目录
[root@bogon ~]# cd /hahaha
[root@bogon hahaha]# touch 123
[root@bogon hahaha]# ll
总用量 16
-rw-r--r--. 1 root root     0 10月 30 11:46 123
drwx------. 2 root root 16384 10月 30 11:43 lost+found
[root@bogon hahaha]# ls
123  lost+found
[root@bogon hahaha]# df -Th
文件系统                类型      容量  已用  可用 已用% 挂载点
/dev/mapper/centos-root xfs        17G   15G  2.6G   85% /
devtmpfs                devtmpfs  897M     0  897M    0% /dev
tmpfs                   tmpfs     912M     0  912M    0% /dev/shm
tmpfs                   tmpfs     912M  9.0M  903M    1% /run
tmpfs                   tmpfs     912M     0  912M    0% /sys/fs/cgroup
/dev/sda1               xfs      1014M  179M  836M   18% /boot
tmpfs                   tmpfs     183M   28K  183M    1% /run/user/0
/dev/sr0                iso9660   4.3G  4.3G     0  100% /run/media/root/CentOS 7 x86_64
/dev/sdb1               ext4      976M  2.6M  907M    1% /hahaha
[root@bogon hahaha]# 

```

上面是临时挂载

得需要永久挂载

```shell
Xshell 5 (Build 0964)
Copyright (c) 2002-2016 NetSarang Computer, Inc. All rights reserved.

Type `help' to learn how to use Xshell prompt.
[d:\~]$ 

Connecting to 192.168.72.130:22...
Connection established.
To escape to local shell, press 'Ctrl+Alt+]'.

Last login: Thu Oct 30 14:20:45 2025
[root@bogon ~]# df -h
文件系统                 容量  已用  可用 已用% 挂载点
/dev/mapper/centos-root   17G   15G  2.6G   85% /
devtmpfs                 897M     0  897M    0% /dev
tmpfs                    912M     0  912M    0% /dev/shm
tmpfs                    912M  9.1M  903M    1% /run
tmpfs                    912M     0  912M    0% /sys/fs/cgroup
/dev/sda1               1014M  179M  836M   18% /boot
tmpfs                    183M  4.0K  183M    1% /run/user/42
tmpfs                    183M   20K  183M    1% /run/user/0
/dev/sr0                 4.3G  4.3G     0  100% /run/media/root/CentOS 7 x86_64
[root@bogon ~]# vim /etc/fstab
[root@bogon ~]# cat /etc/fstab

#
# /etc/fstab
# Created by anaconda on Fri Oct 24 18:22:56 2025
#
# Accessible filesystems, by reference, are maintained under '/dev/disk'
# See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info
#
/dev/mapper/centos-root /                       xfs     defaults        0 0
UUID=676ed796-023c-4200-880e-a476bb69df97 /boot                   xfs     defaults        0 0
/dev/mapper/centos-swap swap                    swap    defaults        0 0

/dev/sdb1             /hahaha     ext4             defaults        0 0

[root@bogon ~]# mount -a
[root@bogon ~]# df -h
文件系统                 容量  已用  可用 已用% 挂载点
/dev/mapper/centos-root   17G   15G  2.6G   85% /
devtmpfs                 897M     0  897M    0% /dev
tmpfs                    912M     0  912M    0% /dev/shm
tmpfs                    912M  9.1M  903M    1% /run
tmpfs                    912M     0  912M    0% /sys/fs/cgroup
/dev/sda1               1014M  179M  836M   18% /boot
tmpfs                    183M  4.0K  183M    1% /run/user/42
tmpfs                    183M   24K  183M    1% /run/user/0
/dev/sr0                 4.3G  4.3G     0  100% /run/media/root/CentOS 7 x86_64
/dev/sdb1                976M  2.6M  907M    1% /hahaha
[root@bogon ~]# init 6

Connection closed by foreign host.

Disconnected from remote host(磁盘挂载) at 14:45:35.

Type `help' to learn how to use Xshell prompt.
[d:\~]$ 

```

关于扩展分区和逻辑分区

EX: 为系统增加2G的空间，要求开机后自动挂载到/hahahaha/目录下，文件系统类型为ext4

```shell
[root@bogon ~]# fdisk /dev/sdb
欢迎使用 fdisk (util-linux 2.23.2)。

更改将停留在内存中，直到您决定将更改写入磁盘。
使用写入命令前请三思。


命令(输入 m 获取帮助)：n
Partition type:
   p   primary (1 primary, 0 extended, 3 free)
   e   extended
Select (default p): e
分区号 (2-4，默认 2)：4
起始 扇区 (2099200-10485759，默认为 2099200)：
将使用默认值 2099200
Last 扇区, +扇区 or +size{K,M,G} (2099200-10485759，默认为 10485759)：
将使用默认值 10485759
分区 4 已设置为 Extended 类型，大小设为 4 GiB

命令(输入 m 获取帮助)：n
Partition type:
   p   primary (1 primary, 1 extended, 2 free)
   l   logical (numbered from 5)
Select (default p): l
添加逻辑分区 5
起始 扇区 (2101248-10485759，默认为 2101248)：
将使用默认值 2101248
Last 扇区, +扇区 or +size{K,M,G} (2101248-10485759，默认为 10485759)：+2G
分区 5 已设置为 Linux 类型，大小设为 2 GiB

命令(输入 m 获取帮助)：w
The partition table has been altered!

Calling ioctl() to re-read partition table.

WARNING: Re-reading the partition table failed with error 16: 设备或资源忙.
The kernel still uses the old table. The new table will be used at
the next reboot or after you run partprobe(8) or kpartx(8)
正在同步磁盘。
[root@bogon ~]# partprobe
Warning: 无法以读写方式打开 /dev/sr0 (只读文件系统)。/dev/sr0 已按照只读方式打开。
[root@bogon ~]# mkfs.
mkfs.btrfs   mkfs.ext2    mkfs.ext4    mkfs.minix   mkfs.vfat    
mkfs.cramfs  mkfs.ext3    mkfs.fat     mkfs.msdos   mkfs.xfs     
[root@bogon ~]# mkfs.ext4 /dev/sdb5
mke2fs 1.42.9 (28-Dec-2013)
文件系统标签=
OS type: Linux
块大小=4096 (log=2)
分块大小=4096 (log=2)
Stride=0 blocks, Stripe width=0 blocks
131072 inodes, 524288 blocks
26214 blocks (5.00%) reserved for the super user
第一个数据块=0
Maximum filesystem blocks=536870912
16 block groups
32768 blocks per group, 32768 fragments per group
8192 inodes per group
Superblock backups stored on blocks: 
	32768, 98304, 163840, 229376, 294912

Allocating group tables: 完成                            
正在写入inode表: 完成                            
Creating journal (16384 blocks): 完成
Writing superblocks and filesystem accounting information: 完成 

[root@bogon ~]# cd /
[root@bogon /]# mkdir hahahaha
[root@bogon /]# ls
bin   dev  hahaha    home  lib64  mnt  proc  run   srv  tmp  var
boot  etc  hahahaha  lib   media  opt  root  sbin  sys  usr

[root@bogon ~]# vim /etc/fstab
[root@bogon ~]# cat  /etc/fstab

#
# /etc/fstab
# Created by anaconda on Fri Oct 24 18:22:56 2025
#
# Accessible filesystems, by reference, are maintained under '/dev/disk'
# See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info
#
/dev/mapper/centos-root /                       xfs     defaults        0 0
UUID=676ed796-023c-4200-880e-a476bb69df97 /boot                   xfs     defaults        0 0
/dev/mapper/centos-swap swap                    swap    defaults        0 0

/dev/sdb1             /hahaha     ext4             defaults        0 0

/dev/sdb5             /hahahaha     ext4             defaults        0 0

[root@bogon ~]# mount -a
[root@bogon ~]# cat /proc/partitions 
major minor  #blocks  name

   8        0   20971520 sda
   8        1    1048576 sda1
   8        2   19921920 sda2
   8       16    5242880 sdb
   8       17    1048576 sdb1
   8       20          0 sdb4
   8       21    2097152 sdb5
  11        0    4415488 sr0
 253        0   17821696 dm-0
 253        1    2097152 dm-1
[root@bogon ~]# 
```

<u>做集群时，做共享存储时，可能会出现盘符漂移的情况，这种情况下必用`UUID`号</u>

```shell
[root@bogon ~]# blkid
/dev/mapper/centos-root: UUID="051ba4cb-eff7-45ef-a4f9-05e124b5dbf5" TYPE="xfs" 
/dev/sda2: UUID="6b1pHT-CkP1-wecN-WgLT-UZt0-aBFL-hfAuNR" TYPE="LVM2_member" 
/dev/sda1: UUID="676ed796-023c-4200-880e-a476bb69df97" TYPE="xfs" 
/dev/mapper/centos-swap: UUID="3d7a8449-a8c2-4397-8702-a9347273ba09" TYPE="swap" 
/dev/sdb1: UUID="c6b93704-22f6-4a5b-9036-b9c60fc52502" TYPE="ext4" 
/dev/sdb5: UUID="8cabbd4c-3b96-4efc-8733-426417f25623" TYPE="ext4" 
/dev/sr0: UUID="2017-09-06-10-51-00-00" LABEL="CentOS 7 x86_64" TYPE="iso9660" PTTYPE="dos" 
[root@bogon ~]# 
[root@bogon ~]# vim /etc/fstab
[root@bogon ~]# vim /etc/fstab
[root@bogon ~]# cat /etc/fstab

#
# /etc/fstab
# Created by anaconda on Fri Oct 24 18:22:56 2025
#
# Accessible filesystems, by reference, are maintained under '/dev/disk'
# See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info
#
/dev/mapper/centos-root /                       xfs     defaults        0 0
UUID=676ed796-023c-4200-880e-a476bb69df97 /boot                   xfs     defaults        0 0
/dev/mapper/centos-swap swap                    swap    defaults        0 0

/dev/sdb1             /hahaha     ext4             defaults        0 0

UUID=8cabbd4c-3b96-4efc-8733-426417f25623             /hahahaha     ext4             defaults        0 0

[root@bogon ~]# mount -a
[root@bogon ~]# cat /proc/partitions 
major minor  #blocks  name

   8        0   20971520 sda
   8        1    1048576 sda1
   8        2   19921920 sda2
   8       16    5242880 sdb
   8       17    1048576 sdb1
   8       20          1 sdb4
   8       21    2097152 sdb5
  11        0    4415488 sr0
 253        0   17821696 dm-0
 253        1    2097152 dm-1
[root@bogon ~]# 
```

重启后查看

```shell
[root@bogon ~]# fdisk -l

磁盘 /dev/sda：21.5 GB, 21474836480 字节，41943040 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
磁盘标签类型：dos
磁盘标识符：0x000e720d

   设备 Boot      Start         End      Blocks   Id  System
/dev/sda1   *        2048     2099199     1048576   83  Linux
/dev/sda2         2099200    41943039    19921920   8e  Linux LVM

磁盘 /dev/sdb：5368 MB, 5368709120 字节，10485760 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
磁盘标签类型：dos
磁盘标识符：0x8ea19066

   设备 Boot      Start         End      Blocks   Id  System
/dev/sdb1            2048     2099199     1048576   83  Linux
/dev/sdb4         2099200    10485759     4193280    5  Extended
/dev/sdb5         2101248     6295551     2097152   83  Linux

磁盘 /dev/mapper/centos-root：18.2 GB, 18249416704 字节，35643392 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节


磁盘 /dev/mapper/centos-swap：2147 MB, 2147483648 字节，4194304 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节

[root@bogon ~]# df -h
文件系统                 容量  已用  可用 已用% 挂载点
/dev/mapper/centos-root   17G   15G  2.6G   85% /
devtmpfs                 897M     0  897M    0% /dev
tmpfs                    912M     0  912M    0% /dev/shm
tmpfs                    912M  9.1M  903M    1% /run
tmpfs                    912M     0  912M    0% /sys/fs/cgroup
/dev/sdb5                2.0G  6.0M  1.8G    1% /hahahaha
/dev/sdb1                976M  2.6M  907M    1% /hahaha
/dev/sda1               1014M  179M  836M   18% /boot
tmpfs                    183M   16K  183M    1% /run/user/0
/dev/sr0                 4.3G  4.3G     0  100% /run/media/root/CentOS 7 x86_64
[root@bogon ~]# 

```

